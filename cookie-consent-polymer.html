<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../byutv-jsonp/byutv-jsonp.html" />
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../neon-animation/animations/fade-out-animation.html">
<!--
The cookie-consent-polymer element provides a dialog with the option to accept website cookies according
to the EU law.
Uses http://freegeoip.net for geolocation.

Example:

    <cookie-consent-polymer
        dialog-text="This website uses cookies to ensure you get the best experience on our website."
        more-info-link="/policy"
        more-info-text="Learn more" #leave empty to disable it
        button-text="Accept"
        cookie-path="/"
        expires-in-days=30></cookie-consent-polymer>

@element cookie-consent-polymer
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="cookie-consent-polymer">

  <template>
    <style>
      :host {
      }
      paper-dialog > *:first-child {
          margin-bottom: 24px;
      }
      #consent_dialog {
        width: 100%;
        height: auto;
        position: absolute;
        bottom: 0;
        display: table;
      }
      #dialog_body, #policy_link, #accept_button {
        display: table-cell;
        vertical-align: middle;

      }
      #accept_button {
        width: 10%;
      }
      #policy_link{
        padding-left: 5px;
      }
    </style>
    <byutv-jsonp id="check_country"
      url="http://freegeoip.net/json/"
      on-response="_checkCountryCode"></byutv-jsonp>

    <paper-dialog id="consent_dialog"
                  no-cancel-on-esc-key="true"
                  no-cancel-on-outside-click="true"
                  entry-animation="scale-up-animation"
                  exit-animation="fade-out-animation">
      <div>
        <p id="dialog_body"></p>
        <a id="policy_link"></a>
      </div>
      <paper-button raised id="accept_button" on-click="_setCookie" dialog-confirm></paper-button>
    </paper-dialog>
  </template>

</dom-module>

<script>

  Polymer({

    is: 'cookie-consent-polymer',

    properties: {

      dialogText: {
        type: String,
        value: "This website uses cookies to ensure you get the best experience on our website."
      },
      moreInfoLink: {
        type: String,
        value: "/policy"
      },
      moreInfoText: {
        type: String,
        value: "More info"
      },
      buttonText: {
        type: String,
        value: "Got it!"
      },
      expiresInDays: {
        type: Number,
        value: 365
      },
      cookiePath: {
        type: String,
        value: '/'
      }
    },

    _countryCodes: function() {
        return [
          'BE',
          'BG',
          'CZ',
          'DK',
          'DE',
          'EE',
          'IE',
          'GR',
          'ES',
          'FR',
          'IT',
          'CY',
          'LV',
          'LT',
          'LU',
          'HU',
          'MT',
          'NL',
          'AT',
          'PL',
          'PT',
          'RO',
          'SI',
          'SK',
          'FI',
          'SE',
          'GB'
        ];
    },

    _setCookie: function() {
      var date = new Date();
      date.setTime(+ date + (this.expiresInDays * 86400000));
      document.cookie = "acceptCookies=true; expires=" + date.toGMTString() + "; path=" + this.cookiePath;
    },

    _cookieExists: function() {
      return (document.cookie.indexOf("acceptCookies") >=0)
    },

    _checkCountryCode: function(e) {
      var code = e.detail.country_code;
      if (this._countryCodes().indexOf(code)){
        this._showDialog();
      }
    },

    _showDialog: function() {
      this.$.dialog_body.textContent = this.dialogText;
      if (this.moreInfoText) {
          this.$.policy_link.textContent = this.moreInfoText;
          this.$.policy_link.href = this.moreInfoLink;
      }
      this.$.accept_button.textContent = this.buttonText;
      this.$.consent_dialog.open();
    },

    attached: function() {
      if (!this._cookieExists()) {
        this.$.check_country.generateRequest();
      }
    }

  });

</script>
